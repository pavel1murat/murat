# -*- mode: tcl -*-
#------------------------------------------------------------------------------
# quick comments: reads signal MC and also background MC inputs with steppoints
# so need to define input and 
#------------------------------------------------------------------------------
BEGIN_PROLOG
  bgHitFiles : @nil
END_PROLOG

#include "fcl/minimalMessageService.fcl"
#include "fcl/standardProducers.fcl"
#include "fcl/standardServices.fcl"


#include "Stntuple/fcl/prolog.fcl"

#------------------------------------------------------------------------------
# global constants for this job
#------------------------------------------------------------------------------
TMin         : 400.
g4ModuleLabel: "g4run"                #  Andrei: detectorFilter
# g4ModuleLabel: "detectorFilter"

process_name : muHitDisplay

source : { 
    #    module_type : EmptyEvent
    module_type : RootInput
    #    fileNames : ["/mu2e/app/users/youzy/mu2e_batch/pbar_20140508/dataDSVacuumToTracker.root"]
    fileNames : ["/mu2e/data/tdr/beam/mixp3/tdr.beam.mix.bg.1516a.15409268/good/00000/data_mixBG.root"]
    maxEvents : -1
    #    fileNames   : [ {INPUT_DATA_FILE} ]
    #    fileNames : ["/mu2e/data/tdr/beam/g4s4p7/tdr.beam.g4s4.flat.1812b.16762780/good/00000/dsStopsToHitsFlat.root"]
    #    maxEvents   : 100

    #    inputCommands : ['keep *_*_*_*'
    #		     , 'drop *_g4filter_*_*'
    #		     , 'drop *_protonTimeMap_*_*'
    #		     , 'drop mu2eStrawDigis_*_*_*'
    #		     , 'drop mu2eStrawHits_*_*_*'
    #		     , 'drop *_CaloReadoutHitsMaker_*_*'
    #		     , 'drop *_CaloCrystalHitsMaker_*_*'
    # Uncomment the above lines to reduce file size.
    #		    ]  
}

services : {
    message               : { @table::default_message }
    TFileService          : { fileName : "muHitDisplay.root" }
    RandomNumberGenerator : { }
    # print per event timing for ::event entry points
    # Timing: { }

    user : {
	GeometryService        : { inputFile      : "JobConfig/TDR/geom_MothersToHits.txt"}
	ConditionsService      : { conditionsfile : "Mu2eG4/test/conditions_01.txt"       }
	GlobalConstantsService : { inputFile      : "Mu2eG4/test/globalConstants_01.txt"  }
	G4Helper          : { }
	SeedService       : { @table::automaticSeeds
	    baseSeed             :  0
	    maxUniqueEngines     :  20
	}
    }
}
#------------------------------------------------------------------------------
# print timing summary
#------------------------------------------------------------------------------
services.scheduler.wantSummary: true

physics : {

    producers: {
	generate             : { @table::StoppedParticleReactionGun 
#------------------------------------------------------------------------------
# for 105 MeV/c electron : E = 105.00130           MeV
# for muon: sqrt(105.*105+105.658*105.658) = 148.9584269653785
# by default, StoppedParticleReactionGun has 'mean' set to +1, 
# which means the Poisson mean of 1 !!! 
#------------------------------------------------------------------------------
	    mean             : -1
	    physics          : {
		pdgId            : 13
		spectrumVariable : "totalEnergy"
		spectrumShape    : "flat"
		elow             : 148.953 
		ehi              : 148.963 
	    }
	}
	
	g4run                : @local::g4run
#------------------------------------------------------------------------------
# hit makers
#------------------------------------------------------------------------------
	CaloReadoutHitsMaker : { @table::MakeCaloReadoutHits
	    g4ModuleLabel : @local::g4ModuleLabel
	}
	CaloCrystalHitsMaker : { @table::CaloCrystalHitsMaker }
        protonTimeMap        : { @table::protonTimeMap        }
        muonTimeMap          : { @table::muonTimeMap          }
        makeSD               : { @table::makeSD
	    g4ModuleLabel : @local::g4ModuleLabel
	}
	makeSH               : { @table::makeSHfromSD
	    g4ModuleLabel : @local::g4ModuleLabel
	}
#------------------------------------------------------------------------------
#  default tracking
#------------------------------------------------------------------------------
	FSHPreStereo         : @local::FSHPreStereo
	MakeStereoHits       : @local::MakeStereoHits
	FlagStrawHits        : { @table::FlagStrawHits 
	    minimumTime : @local::TMin
	}
	FlagBkgHits          : @local::FlagBkgHits
	TrkPatRec            : { @table::TrkPatRecDownstreameMinus
	    tmin        : @local::TMin
	}
#------------------------------------------------------------------------------
# CalPatRec modules
#------------------------------------------------------------------------------
	MakeCaloCluster                 : { @table::MakeCaloCluster }
	CalPatRecFSHP                   : { @table::CalPatRecFSHP   }
	CalPatRecMakeStereoHits         : { @table::CalPatRecMakeStereoHits }
	CalPatRecFlagStrawHits          : { @table::CalPatRecFlagStrawHits
	    minimumTime : @local::TMin
	}
	CalPatRecFlagBkgHits            : @local::CalPatRecFlagBkgHits
	CalPatRec                       : { @table::CalPatRec
	    diagLevel   : 1
	    debugLevel  : 1
	    useDoublets : 1
	    tmin        : @local::TMin
#
	    HelixFitHack: { @table::CalPatRec.HelixFitHack
		diagLevel  : 1  
		debugLevel : 100
		chi2xyMax          : 5.0  # default value is 300
		chi2zphiMax        : 6.0  # 0.1 #default is 0.1, use 0.05 for debugging puposes
	    }
#
	    SeedFitHack: { @table::CalPatRec.SeedFitHack
		debugLevel : 1
		minnstraws : 10
#		hiterr             : [ 5.0, 1.44 ]

		ambiguityStrategy  : [ 0    ]
		hiterr             : [ 5.0  ]
		t0Tolerance        : [ 5.0  ]   
		weedhits           : [ true ]   
	    }
#
	    KalFitHack: { @table::CalPatRec.KalFitHack
		debugLevel        : 10
		iLoopUseDoublets  : 8
		scaleErrDoublet   : 10.
		# hiterr              : [ 5,   0.5,  0.25, 0 ]
		# ambiguityStrategy   : [ 0,     0,  4   , 4]
		# t0Tolerance         : [ 2.0, 1., 0.25 , 0.1]   
	    }
	}

	MergePatRec          : @local::MergePatRec
	#------------------------------------------------------------------------------
	# needed for analysis
	#------------------------------------------------------------------------------
	CaloMatching         : { @table::TrackCaloMatching  fitterModuleLabel: MergePatRec }
	TrkExtrapol          : { @table::TrkExtrapol        fitterModuleLabel: MergePatRec }
	ParticleID           : { @table::ParticleID         fitterModuleLabel: MergePatRec }
    }

    filters: {
	MuHitDisplay         : { @table::MuHitDisplay
	    strawHitPosMakerModuleLabel : CalPatRecMakeStereoHits
	    strawHitFlagMakerModuleLabel: CalPatRecFlagBkgHits
	}
    }


    #------------------------------------------------------------------------------
    # paths
    # write out ntuple only, so don't need compression modules...
    #------------------------------------------------------------------------------
    p1 : [ 
	  #  protonTimeMap, muonTimeMap 
	  # , makeSD, makeSH
	  # , CaloReadoutHitsMaker, CaloCrystalHitsMaker
	  , MakeCaloCluster
	  # 
	  , FSHPreStereo, MakeStereoHits, FlagStrawHits, FlagBkgHits, TrkPatRec 
	  #
	  , CalPatRecFSHP, CalPatRecMakeStereoHits
	  , CalPatRecFlagStrawHits, CalPatRecFlagBkgHits 
	  , CalPatRec

	  , MergePatRec
	  #	  
	  , TrkExtrapol, CaloMatching, ParticleID
	  #
	  #	  , InitStntuple, StntupleMaker, FillStntuple
	  ,MuHitDisplay
	 ]

    trigger_paths  : [p1]
    
    #    out : [detectorOutput]
    out : []
    #    an  : [genCountLogger]
    end_paths      : [out]
}

outputs: {
    detectorOutput : {
        module_type : RootOutput
	#        SelectEvents: { SelectEvents: [p1] }
        outputCommands:   [ "keep *_*_*_*",
                            "drop uintmu2e::PhysicalVolumeInfomvstd::pairs_g4run_*_*"
			   ]
        fileName    : "muHitDisplay.art"
    }
}

