# -*- mode: tcl -*-
# to be used by submit_mu2e_job
#
# $Id: stnmaker_remake_hits.fcl,v 1.1 2014/03/21 05:22:32 murat Exp $
# $Author: murat $
# $Id: stnmaker_remake_hits.fcl,v 1.1 2014/03/21 05:22:32 murat Exp $

#include "fcl/minimalMessageService.fcl"
#include "fcl/standardProducers.fcl"
#include "fcl/standardServices.fcl"

process_name : stnmaker

source : {
  module_type : RootInput
  fileNames   : [ "undefined" ]
  maxEvents   : -1
}

outputs: {
    outfile : {
	module_type    : RootOutput
	fileName       : "{DATASET}.{JOB}.strip.root"
	SelectEvents  : { SelectEvents: [ p1 ] }
#------------------------------------------------------------------------------
# as hits are regenerated anyway, drop hits on input, if they exist
#------------------------------------------------------------------------------
	outputCommands : ['keep *_*_*_*'
			  , 'drop mu2eStrawDigis_*_*_*'
			  , 'drop mu2eStrawHits_*_*_*'
			  , 'drop *_CaloReadoutHitsMaker_*_*'
			  , 'drop *_CaloCrystalHitsMaker_*_*'
			  , 'drop mu2eCaloClusters_*_*_*'
			  #                   , 'drop mu2ePointTrajectoryMapVector_*_*_*'
			  #                   , 'drop mu2eSimParticles_*_*_*'
			  # Uncomment the above line to reduce file size.
			 ]  
    }
}

services : {
  message               : @local::default_message
    TFileService          : { fileName : "{DATASET}.{JOB}.hist"}
    RandomNumberGenerator : { }

  user : {
    GeometryService        : { inputFile      : "Mu2eG4/test/geom_01.txt"        }
    ConditionsService      : { conditionsfile : "Mu2eG4/test/conditions_01.txt"      }
    GlobalConstantsService : { inputFile      : "Mu2eG4/test/globalConstants_01.txt" }
###    G4Helper               : { }
      SeedService            : @local::automaticSeeds
  }
}

physics : {

  producers : {
    protonTimeMap        : { module_type : GenerateProtonTimes }
    muonTimeMap          : { module_type : GenerateMuonLife }
    makeSD               : @local::makeSD
    makeSH               : @local::makeSHfromSD

    CaloReadoutHitsMaker : @local::CaloReadoutHitsMaker
    CaloCrystalHitsMaker : @local::CaloCrystalHitsMaker

    MakeStereoHits       : @local::MakeStereoHits
    FlagStrawHits        : @local::FlagStrawHits
    FlagBkgHits          : @local::FlagBkgHits
      
    TrkPatRec : @local::TrkPatRecDownstreameMinus
#    trkPatRec2 : @local::TrkPatRecUpstreamePlus
#    trkPatRec3 : @local::TrkPatRecDownstreammuMinus
#    trkPatRec4 : @local::TrkPatRecUpstreammuPlus

    MakeCaloCluster: {
      module_type                   : MakeCaloClusterNew
      diagLevel                     : 0
      generatorModuleLabel          : generate
      caloCrystalModuleLabel        : CaloCrystalHitsMaker
      g4ModuleLabel                 : g4run
      #caloReadoutModuleLabel: CaloReadoutHitsMaker
      caloClusterAlgorithm          : closest
      caloClusterSeeding            : energy
      #     caloClusterSeeding    : time
      deltaTime                     : 10.0 #ns
      nCryPerCrystal                : 1
      EnoiseCut                     : 0.00 #MeV
      EclusterCut                   : 0.00 #MeV  
      maxFullPrint                  : 201
    }

    trkExtrapol : {
	  module_type                  : TrkExtrapol
	  diagLevel                    : 1
	  fitterModuleLabel            : TrkPatRec
	  maxNumberStoresPoints        : 1
	  # MC truth finder, analyzer configuration
	  KalFitMC : {
	  }        
      }

      caloMatching : {
	  module_type                  : CaloMatching
	  diagLevel                    : 1
	  fitterModuleLabel            : TrkPatRec
	  trkToCaloExtrapolModuleLabel : trkExtrapol
	  caloClusterModuleLabel       : MakeCaloCluster
	  outPutNtup                   : 0
	  caloClusterAlgorithm         : closest
	  caloClusterSeeding           : energy
      }
     PidDem : {
	 module_type       : ParticleID
	 fitterModuleLabel : TrkPatRec
	 fitparticle       : 11
	 fitdirection      : 0
	 verbosity         : 0
	 diagLevel         : 1 
	 doDisplay         : false
     }
  }
  filters: {
#------------------------------------------------------------------------------
# Stntuple maker sequence
#------------------------------------------------------------------------------
      InitStntuple : { 
	  module_type       : InitStntuple
	  module_name       : InitStntuple

	  histFileName      : "{DATASET}.{JOB}.stn"
	  splitLevel        : 0

	  debugBits         : { 
	      # bit0:1  
	      # bit1:1 
	      # bit51:1
	  }
      }

      StntupleMaker : { 
	  module_type         : StntupleMaker
	  module_name         : StntupleMaker

	  processName         : test

	  strawHitMaker       : makeSH
	  caloCrystalHitMaker : CaloCrystalHitsMaker
	  caloClusterMaker    : MakeCaloCluster
	  trkPatRecDem        : TrkPatRec
	  trkExtrapol         : trkExtrapol
	  trkCalMatch         : caloMatching
	  pidDem              : PidDem

	  makeCalData         : 1
	  makeStrawData       : 1
	  makeTracks          : 1
	  makeClusters        : 1
	  makeGenp            : 1
			      
	  minTActive          : 0.
	  debugBits           : { 
	      # bit0:1  
	      # bit1:1 
	      # bit51:1
	  }
      }

      FillStntuple : { 
	  module_type       : FillStntuple
	  module_name       : FillStntuple

	  debugBits         : { 
	      # bit0:1  
	      # bit1:1 
	      # bit51:1
	  }
      }
  }
#------------------------------------------------------------------------------
# analysis modules
#
# tcalm002 bit 51: write out events with matched tracks
# need to regenerate all hits for consistent timing
#------------------------------------------------------------------------------
  analyzers : {
  }
  
  p1 : [ protonTimeMap, muonTimeMap, 
	 makeSD, makeSH,
         CaloReadoutHitsMaker, CaloCrystalHitsMaker, MakeCaloCluster, 
         MakeStereoHits, FlagStrawHits, FlagBkgHits, TrkPatRec, 
         trkExtrapol, caloMatching, 
	 PidDem,
         InitStntuple, StntupleMaker, FillStntuple
       ]

  e1 : [ outfile ]
#  e1 : [  ]

  trigger_paths  : [p1]
  #  trigger_paths  : []
  #  end_paths      : [e1]
  end_paths      : []
}


services.user.SeedService.baseSeed         :   0
services.user.SeedService.maxUniqueEngines :  20

# print per event timing for ::event entry points
# services.Timing: { }
# print 
services.scheduler.wantSummary: true

# Apply the time offsets in tracker digitization
physics.producers.makeSD.TimeOffsets               :  { inputs : [ "protonTimeMap", "muonTimeMap" ] }
physics.producers.CaloReadoutHitsMaker.TimeOffsets :  { inputs : [ "protonTimeMap", "muonTimeMap" ] }
