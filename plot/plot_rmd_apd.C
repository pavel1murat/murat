// fit results:
// Minimizer is Minuit / Migrad
// Chi2                      =    0.0112719
// NDf                       =           61
// Edm                       =  1.14516e-06
// NCalls                    =          641
// p0                        =     0.157818   +/-   0.00774748  
// p1                        =      192.176   +/-   0.418778    
// p2                        =      7.12085   +/-   0.436036    
// p3                        =     0.298561   +/-   0.00599175  
// p4                        =      220.776   +/-   0.249987    
// p5                        =      10.3246   +/-   0.34516     
// p6                        =     0.936461   +/-   0.0245948   
// p7                        =      304.715   +/-   0.813058    
// p8                        =      29.2928   +/-   0.462772    
// p9                        =     0.204424   +/-   0.00997294  
// p10                       =      377.384   +/-   5.84059     
// p11                       =      38.9428   +/-   4.40413     

// 5-layer efficiency vs the wavelength

float apd_eff_data [] = {
  199.995,0.0473919,
  203.502,0.0787094,
  206.103,0.104656,
  208.251,0.132389,
  210.965,0.168173,
  213.790,0.218264,,
  216.276,0.265671,
  218.763,0.305924,
  220.460,0.315770,
  221.706,0.314883,
  223.517,0.311317,
  224.650,0.303276,
  226.123,0.289872,
  229.976,0.253234,,
  234.735,0.202293,
  239.721,0.154037,
  243.800,0.119188,
  249.577,0.0789840,
  254.900,0.0566611,
  260.223,0.0397032,
  264.638,0.0307877,
  269.620,0.0245581,
  275.281,0.0165441,
  281.282,0.0112148,
  287.848,0.0103597,
  296.904,0.0113079,
  304.603,0.00956544,
  317.055,0.0114280,
  326.678,0.0105912,
  334.942,0.0115347,
  350.112,0.00894254,
  -1
};


float baf2_emission_spectrum_data[] = {
  165.227,0.00160514,
  171.104,0.00963082,
  176.180,0.0176565,
  178.050,0.0304976,
  181.256,0.0497592,
  183.126,0.0786517,
  185.797,0.104334,
  187.133,0.115570,
  188.201,0.138042,
  189.537,0.150883,
  193.544,0.157303,
  196.750,0.154093,
  198.620,0.144462,
  200.757,0.133226,
  202.894,0.126806,
  204.764,0.121990,
  206.634,0.120385,
  207.970,0.133226,
  209.038,0.155698,
  210.374,0.182986,
  211.977,0.211878,
  213.045,0.243981,
  214.648,0.272873,
  215.717,0.295345,
  216.251,0.313002,
  219.991,0.313002,
  222.930,0.301766,
  224.265,0.292135,
  225.601,0.274478,
  228.540,0.245586,
  230.677,0.231140,
  232.814,0.202247,
  234.417,0.174960,
  237.622,0.158909,
  241.095,0.154093,
  244.835,0.154093,
  248.041,0.160514,
  250.712,0.171750,
  253.651,0.195827,
  255.788,0.226324,
  260.864,0.322632,
  267.542,0.439807,
  273.687,0.539326,
  279.564,0.645265,
  285.975,0.746388,
  291.051,0.829856,
  295.325,0.903692,
  297.729,0.940610,
  300.668,0.964687,
  303.606,0.982343,
  306.011,1.00000,
  308.949,0.998395,
  309.751,0.983949,
  312.155,0.961477,
  316.429,0.910112,
  320.436,0.858748,
  325.779,0.791332,
  330.855,0.720706,
  336.198,0.637239,
  342.609,0.550562,
  347.418,0.481541,
  350.089,0.439807,
  352.493,0.410915,
  356.233,0.377207,
  360.775,0.341894,
  366.385,0.304976,
  371.995,0.274478,
  379.207,0.237560,
  388.557,0.207063,
  400.846,0.166934,
  412.600,0.136437,
  425.690,0.102729,
  437.444,0.0658106,
  448.931,0.0337079,
  -1
};


TGraph* gr_apd_eff, *gr_baf2;

TCanvas  *c_apd_eff, *c_baf2;

//-----------------------------------------------------------------------------
double f_220(double X) {
  double dx = (X-220.8)/10.32;
  
  double f = TMath::Exp(-dx*dx/2);

  return f;
}


//------------------------------------------------------------------------------
double fun(double* X, double* P) {
  double f(0);

  double x = X[0];

  double dx1, dx2, dx3, dx4;
  
  dx1 = (x-P[1])/P[2];
  dx2 = (x-P[4])/P[5];
  dx3 = (x-P[7])/P[8];
  dx4 = (x-P[10])/P[11];
  
  f = P[0]*TMath::Exp(-dx1*dx1/2.) +
    P[3]*TMath::Exp(-dx2*dx2/2.) +
    P[6]*TMath::Exp(-dx3*dx3/2.) +
    P[9]*TMath::Exp(-dx4*dx4/2.);

  return f;
}

//-----------------------------------------------------------------------------
int plot_apd_efficiency() {

  float x[1000], y[1000];

  int n(0);

  for (int i=0; apd_eff_data[i] >= 0; ) {
    x[n] = apd_eff_data[i];
    y[n] = apd_eff_data[i+1];
    i += 2;
    n += 1;
  }

  gr_apd_eff = new TGraph(n,x,y);
  gr_apd_eff->SetTitle("5-layer RMP APD efficiency");
  gr_apd_eff->GetXaxis()->SetTitle("Wavelength, nm");

  printf("n = %i\n",n);


  c_apd_eff = new TCanvas("c_pad_eff","APD eff",0,0,1100,700);
  c_apd_eff->cd();
  gr_apd_eff->Draw();
//-----------------------------------------------------------------------------
// create emission spectrum graph
//-----------------------------------------------------------------------------
  int np1 = 0;
  float sum(0), sumw(0);
  
  for (int i=0; baf2_emission_spectrum_data[i] >= 0; ) {
    x[np1] = baf2_emission_spectrum_data[i];
    y[np1] = baf2_emission_spectrum_data[i+1];
    i     += 2;

    if ((x[np1] > 199.) && ( x[np1] < 350)) {
      aa     = f_220(x[np1]);
      sum   += aa;
      sumw  += aa*gr_apd_eff->Eval(x[np1]);
    }

    np1 += 1;
  }

  gr_baf2 = new TGraph(np1,x,y);
  gr_baf2->SetTitle("BaF2 Emission Spectrum");
  gr_baf2->GetXaxis()->SetTitle("Wavelength, nm");

  printf("np1 = %i\n",np1);

  printf("sum, sumw = %10.3f %10.3f \n",sum, sumw);



  c_baf2 = new TCanvas("c_baf2","BaF2",0,0,1100,700);
  c_baf2->cd();
  //  gr_baf2->Draw("same");

  
  gr_baf2->Draw("");


  TF1* f_baf2 = new TF1("f_baf2",fun,150,450,12);


  f_baf2->SetParameter(0,0.15);
  f_baf2->SetParameter(1,195.);
  f_baf2->SetParameter(2,5.);

  f_baf2->SetParameter(3,0.3);
  f_baf2->SetParameter(4,220.);
  f_baf2->SetParameter(5,5.);

  f_baf2->SetParameter(6,1.0);
  f_baf2->SetParameter(7,310.);
  f_baf2->SetParameter(8,25.);

  f_baf2->SetParameter( 9,0.1);
  f_baf2->SetParameter(10,400.);
  f_baf2->SetParameter(11,35.);


  gr_baf2->Fit(f_baf2,"","APL",170,450);

  
}
